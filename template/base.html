<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ø³ÛŒØ³ØªÙ… HSE{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette Ù…Ø¯Ø±Ù†â€ŒØªØ± */
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;

            /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù„ */
            --sidebar-bg: #212529;
            --sidebar-link-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: #007bff;
            --bg-light: #f8f9fa;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg-light);
            color: #333;
        }

        /* ------------------------------------------------------------------ */
        /* ğŸ’¡ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ (Ú©Ù„ÛŒØ¯ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„) */
        /* ------------------------------------------------------------------ */
        .sidebar {
            background: var(--sidebar-bg);
            color: white;
            min-height: 100vh;
            width: 250px;
            position: fixed;
            right: 0;
            top: 0;
            transition: all 0.3s;
            z-index: 1050;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            margin-right: 250px; /* ÙØ¶Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
            padding: 20px;
            transition: all 0.3s;
        }

        /* Overlay Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            transition: opacity 0.3s;
        }

        @media (max-width: 768px) {
            /* 1. Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            .sidebar {
                right: -250px;
            }

            /* 2. Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            .sidebar.active {
                right: 0;
            }

            /* 3. Ø­Ø°Ù Ø­Ø§Ø´ÛŒÙ‡â€ŒÛŒ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            .main-content {
                margin-right: 0;
            }

            /* 4. Ù†Ù…Ø§ÛŒØ´ Overlay Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± */
            .sidebar.active ~ .sidebar-overlay {
                display: block;
            }

            /* 5. Ø¯Ú©Ù…Ù‡ Toggle Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯ */
            .navbar-brand {
                order: 3; /* Ø§Ù†ØªÙ‚Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø¨Ù‡ Ø³Ù…Øª Ú†Ù¾ Ø¨Ø±Ø§ÛŒ RTL */
            }
            .navbar-nav-scroll {
                max-width: 70%; /* Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø³Ø±Ø±ÛŒØ² Ø´Ø¯Ù† Ù…Ø­ØªÙˆØ§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            }

            /* 6. Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù‡Ù…ÛŒØ´Ù‡ 100% Ø¹Ø±Ø¶ Ø¨Ú¯ÛŒØ±Ù†Ø¯ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø³ØªÚ© Ø´Ø¯Ù†) */
            .row > div[class*="col-"] {
                margin-bottom: 15px; /* Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ù…ÙˆØ¯ÛŒ */
            }

            /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Toggle Ø¯Ø§Ø®Ù„ÛŒ (ÙÙ‚Ø· Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯) */
            #sidebarClose {
                display: block;
            }
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ø³Ú©ØªØ§Ù¾ (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø³Ú©ØªØ§Ù¾) */
        @media (min-width: 769px) {
             #sidebarClose {
                display: none !important;
            }
        }

        /* ------------------------------------------------------------------ */
        /* ğŸ¨ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ (Ø§Ø² Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ) */
        /* ------------------------------------------------------------------ */

        .nav-link {
            color: #adb5bd;
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            color: white;
            background: var(--sidebar-link-hover);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.5);
        }

        .nav-link i {
            width: 20px;
            margin-left: 10px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Ø¨Ù‚ÛŒÙ‡ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ (Card, Stat-Card, Button, Table, etc.) Ø§ÛŒÙ†Ø¬Ø§ ØªÚ©Ø±Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ */
        .sidebar .p-4 h4 { font-weight: 700; }
        .sidebar .nav-link.text-danger { color: var(--danger) !important; }
        .sidebar .nav-link.text-danger:hover { background: rgba(220, 53, 69, 0.1); color: var(--danger) !important; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); margin-bottom: 25px; }
        .card-header { background: white; border-bottom: 1px solid #eee; border-radius: 12px 12px 0 0 !important; padding: 15px 20px; font-weight: 600; font-size: 1.1rem; color: var(--primary); }
        .stat-card { padding: 25px; border-radius: 12px; color: white; text-align: right; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stat-card .number { font-size: 2.5rem; font-weight: bold; display: block; }
        .stat-card .title { opacity: 0.8; font-size: 0.9rem; }
        .stat-card i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 4rem; opacity: 0.2; }
        .badge { padding: 7px 14px; border-radius: 50px; font-weight: 600; font-size: 0.85rem; }
        .btn { border-radius: 8px; padding: 10px 25px; font-weight: 500; transition: all 0.2s; }
        .table { border-radius: 10px; overflow: hidden; }
        .table th { background: #e9ecef; color: #495057; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        .form-control, .form-select { border-radius: 8px; padding: 10px 15px; border: 1px solid #ced4da; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25); }
        .alert { border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-weight: 500; }
        .navbar { border-radius: 12px !important; padding: 10px 20px; }
        .page-title-container h2 { font-weight: 700; color: #212529; font-size: 1.8rem; }
        .dropdown-menu { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ú©Ø§Ø±Ø¯Ø¦ÙˆÙ† (Ø²ÛŒØ±Ù…Ù†Ùˆ) */
        .accordion-button { background: transparent !important; color: #adb5bd !important; box-shadow: none !important; padding: 12px 20px; font-weight: 500; }
        .accordion-button:not(.collapsed) { color: white !important; background: var(--sidebar-link-hover) !important; }
        .accordion-collapse { border: none !important; }
        .accordion-body { padding: 0; }
        .accordion-body .nav-link { padding-right: 40px; font-size: 0.95rem; }

    </style>
</head>
<body style=" font-family: 'Vazirmatn', sans-serif;">

    <div class="sidebar">
        <div class="p-4 d-flex justify-content-between align-items-center">
            <h4 class="text-white mb-0">
                <i class="fas fa-shield-alt text-primary me-2"></i>
                HSE
            </h4>
             <button class="btn btn-outline-light d-md-none" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <small class="text-white-50 px-4">Ù…Ø¯ÛŒØ±ÛŒØª Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª</small>


        <hr class="border-secondary mx-3">

        <nav class="nav flex-column">

            {% if company %}
            <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
               href="{% url 'hse:dashboard' company.id %}">
                <i class="fas fa-tachometer-alt"></i>
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </a>

            <div class="accordion accordion-flush" id="sidebarAccordion">
                <div class="accordion-item" style="background-color: transparent; border: none;">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed nav-link d-block text-end" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStructure" aria-expanded="false" aria-controls="collapseStructure">
                            <i class="fas fa-building float-end me-1 mt-1"></i>
                            Ø³Ø§Ø®ØªØ§Ø± Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ
                            <i class="fas fa-chevron-down float-start mt-1" style="font-size: 0.7rem;"></i>
                        </button>
                    </h2>
                    <div id="collapseStructure" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                        <div class="accordion-body">
                            <a class="nav-link {% if 'company_detail' in request.resolver_match.url_name %}active-sub{% endif %}"
                               href="{% url 'hse:company_detail' company.id %}" >
                                <i class="fas fa-info-circle"></i>
                                Ø¬Ø²Ø¦ÛŒØ§Øª Ø´Ø±Ú©Øª
                            </a>
                            <a class="nav-link {% if 'department' in request.resolver_match.url_name %}active-sub{% endif %}"
                               href="{% url 'hse:department_list' company.id %}" >
                                <i class="fas fa-sitemap"></i>
                                Ù„ÛŒØ³Øª Ø¨Ø®Ø´â€ŒÙ‡Ø§
                            </a>
                            <a class="nav-link {% if 'member' in request.resolver_match.url_name and 'invitation' not in request.resolver_match.url_name %}active-sub{% endif %}"
                               href="{% url 'hse:member_list' company.id %}" >
                                <i class="fas fa-users"></i>
                                Ø§Ø¹Ø¶Ø§ÛŒ Ø´Ø±Ú©Øª
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <a class="nav-link {% if 'inspection' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:inspection_list' company.id %}">
                <i class="fas fa-clipboard-check"></i>
                Ø¨Ø§Ø²Ø±Ø³ÛŒâ€ŒÙ‡Ø§
            </a>

            <a class="nav-link {% if 'incident' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:incident_list' company.id %}">
                <i class="fas fa-exclamation-triangle"></i>
                Ø­ÙˆØ§Ø¯Ø«
            </a>

            <a class="nav-link {% if 'task' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:task_list' company.id %}">
                <i class="fas fa-tasks"></i>
                ÙˆØ¸Ø§ÛŒÙ
            </a>

            <hr class="border-secondary mx-3 my-2">

            <a class="nav-link {% if 'training' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:training_create' company.id %}">
                <i class="fas fa-graduation-cap"></i>
                Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§
            </a>

            <a class="nav-link {% if 'invitation' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:invitation_list' company.id %}">
                <i class="fas fa-user-plus"></i>
                Ø¯Ø¹ÙˆØª Ùˆ Ø¹Ø¶ÙˆÛŒØª
            </a>

            <a class="nav-link {% if 'ai_assistant' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:ai_assistant' %}">
                <i class="fas fa-robot"></i>
                Ù…Ø´Ø§ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
            </a>

            {% endif %}

            <hr class="border-secondary mx-3 my-2">

            <a class="nav-link {% if 'notification' in request.resolver_match.url_name %}active{% endif %}"
               href="{% url 'hse:notification_list' %}">
                <i class="fas fa-bell"></i>
                Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§
                <span id="notification-badge" class="badge bg-danger ms-auto" style="display: none; margin-right: 0;">0</span>
            </a>

            <a class="nav-link {% if request.resolver_match.url_name == 'company_list' %}active{% endif %}"
               href="{% url 'hse:company_list' %}">
                <i class="fas fa-list"></i>
                Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†
            </a>

            <div class="mt-auto pt-3 border-top border-secondary mx-3">
                <a class="nav-link text-danger" href="#">
                    <i class="fas fa-sign-out-alt"></i>
                    Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-content">
        <nav class="navbar navbar-light bg-white rounded-3 shadow-sm mb-4">
            <div class="container-fluid">
                <button class="btn btn-outline-secondary d-md-none" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="navbar-brand me-auto ms-3">
                    <h5 class="mb-0 text-primary">
                        {% if company %}<i class="fas fa-industry me-2"></i>{{ company.name }}{% else %}<i class="fas fa-shield-alt me-2"></i>Ø³ÛŒØ³ØªÙ… HSE{% endif %}
                    </h5>
                </div>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-2"></i>
                        {{ request.user.get_full_name|default:request.user.name|default:"Ú©Ø§Ø±Ø¨Ø±" }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-start">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog me-2"></i>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-sign-out-alt me-2"></i>Ø®Ø±ÙˆØ¬</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close me-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4 page-title-container">
            <h2 class="mb-0">
                {% block page_title %}{{ page_title|default:"Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ" }}{% endblock %}
            </h2>
            {% block page_actions %}{% endblock %}
        </div>

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Overlay
        $(document).ready(function() {
            const sidebar = $('.sidebar');
            const sidebarToggle = $('#sidebarToggle');
            const sidebarClose = $('#sidebarClose');
            const sidebarOverlay = $('#sidebarOverlay');

            function toggleSidebar() {
                sidebar.toggleClass('active');
                if (sidebar.hasClass('active')) {
                    // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø¯Ù†Ù‡ Ø²ÛŒØ± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
                    $('body').css('overflow', 'hidden');
                } else {
                    $('body').css('overflow', 'auto');
                }
            }

            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§
            sidebarToggle.on('click', toggleSidebar);

            // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Close (X) Ø¯Ø§Ø®Ù„ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
            sidebarClose.on('click', toggleSidebar);

            // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Overlay
            sidebarOverlay.on('click', toggleSidebar);

            // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù‡Ø± Ù„ÛŒÙ†Ú© Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
            $('.nav-link').on('click', function() {
                if ($(window).width() <= 768) {
                    // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ± ØµÙØ­Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø³ØªÙ†
                    setTimeout(toggleSidebar, 200);
                }
            });

            // -----------------------------------------------------
            // Ù…Ù†Ø·Ù‚ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
            // -----------------------------------------------------
            function updateNotificationBadge() {
                $.get('{% url "hse:notification_count" %}', function(data) {
                    const badge = $('#notification-badge');
                    if (data.count > 0) {
                        badge.text(data.count).show();
                    } else {
                        badge.hide();
                    }
                });
            }

            updateNotificationBadge();
            // 30 Ø«Ø§Ù†ÛŒÙ‡
            setInterval(updateNotificationBadge, 30000);

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>