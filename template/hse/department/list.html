<!-- templates/hse/department/list.html -->
{% extends 'base.html' %}

{% block title %}بخش‌های شرکت {{ company.name }}{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'hse:department_create' company.id %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>بخش جدید
    </a>
    <a href="{% url 'hse:company_detail' company.id %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-2"></i>بازگشت به شرکت
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-sitemap text-primary me-2"></i>
                        بخش‌های شرکت {{ company.name }}
                    </h5>
                    <small class="text-muted">مدیریت بخش‌های سازمانی شرکت</small>
                </div>
                <span class="badge bg-primary">
                    <i class="fas fa-layer-group me-1"></i>
                    {{ departments.count }} بخش
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- آمار -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-body text-center">
                <div class="text-primary fw-bold h2">{{ departments.count }}</div>
                <small class="text-muted">کل بخش‌ها</small>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body text-center">
                <div class="text-success fw-bold h2">{{ active_departments }}</div>
                <small class="text-muted">بخش فعال</small>
            </div>
        </div>

        <div class="card">
            <div class="card-body text-center">
                <div class="text-info fw-bold h2">{{ total_employees }}</div>
                <small class="text-muted">کل کارکنان</small>
            </div>
        </div>
    </div>

    <!-- لیست بخش‌ها -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">لیست بخش‌ها</h6>
                    <div class="input-group" style="width: 250px;">
                        <input type="text" class="form-control form-control-sm"
                               placeholder="جستجوی بخش..." id="searchDepartment">
                        <button class="btn btn-outline-secondary btn-sm" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                {% if departments %}
                <div class="table-responsive">
                    <table class="table table-hover" id="departmentTable">
                        <thead>
                            <tr>
                                <th>نام بخش</th>
                                <th>تعداد کارکنان</th>
                                <th>مدیر بخش</th>
                                <th>وضعیت</th>
                                <th>تاریخ ایجاد</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for department in departments %}
                            <tr data-department-id="{{ department.id }}">
                                <td>
                                    <strong>{{ department.name }}</strong>
                                    {% if department.description %}
                                    <div class="text-muted small mt-1">
                                        {{ department.description|truncatechars:50 }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        <i class="fas fa-users me-1"></i>
                                        {{ department.employee_count }}
                                    </span>
                                </td>
                                <td>
                                    {% if department.manager %}
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-tie text-success me-2"></i>
                                        <div>
                                            {% comment %} <div>{{ department.manager.user.full_name|default:department.manager.user.mobileNumber }}</div> {% endcomment %}
                                            <small class="text-muted">{{ department.manager.get_position_display }}</small>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-user-times me-1"></i>
                                        تعیین نشده
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if department.is_active %}
                                    <span class="badge bg-success" id="status-{{ department.id }}">
                                        <i class="fas fa-check-circle me-1"></i>فعال
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary" id="status-{{ department.id }}">
                                        <i class="fas fa-times-circle me-1"></i>غیرفعال
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ department.created_at|date:"Y/m/d" }}
                                    <div class="text-muted small">
                                        {{ department.created_at|timesince }} پیش
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class="btn btn-outline-info" title="مشاهده">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'hse:department_edit' company.id department.id %}"
                                           class="btn btn-outline-warning" title="ویرایش">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-danger toggle-department-status"
                                                data-department-id="{{ department.id }}"
                                                data-department-name="{{ department.name }}"
                                                title="تغییر وضعیت">
                                            <i class="fas fa-power-off"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-sitemap fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">هنوز بخشی ایجاد نکرده‌اید</h5>
                    <p class="text-muted mb-4">برای شروع مدیریت بخش‌های شرکت، اولین بخش را ایجاد کنید.</p>
                    <a href="{% url 'hse:department_create' company.id %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>ایجاد اولین بخش
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal حذف بخش -->
<div class="modal fade" id="deleteDepartmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    حذف بخش
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>آیا مطمئن هستید که می‌خواهید بخش "<strong id="deleteDepartmentName"></strong>" را حذف کنید؟</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    در صورت حذف بخش:
                    <ul class="mb-0 mt-2">
                        <li>اعضای این بخش به بخش تعیین نشده منتقل می‌شوند</li>
                        <li>بازرسی‌ها و حوادث مرتبط حفظ می‌شوند</li>
                    </ul>
                </div>
                <div class="form-check mt-3">
                    <input type="checkbox" class="form-check-input" id="confirmDepartmentDelete">
                    <label class="form-check-label text-danger" for="confirmDepartmentDelete">
                        تایید می‌کنم که می‌خواهم این بخش را حذف کنم
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-danger" id="confirmDepartmentDeleteBtn" disabled>
                    <i class="fas fa-trash me-2"></i>حذف بخش
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // جستجوی بخش‌ها
    $('#searchDepartment').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('#departmentTable tbody tr').each(function() {
            const text = $(this).text().toLowerCase();
            if (text.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // تغییر وضعیت بخش
    $('.toggle-department-status').click(function(e) {
        e.preventDefault();
        const departmentId = $(this).data('department-id');
        const departmentName = $(this).data('department-name');
        const currentStatus = $('#status-' + departmentId).hasClass('bg-success');
        const newStatus = !currentStatus;

        if (confirm(`آیا می‌خواهید بخش "${departmentName}" را ${newStatus ? 'فعال' : 'غیرفعال'} کنید؟`)) {
            // ساخت URL به صورت دستی
            const toggleUrl = `/hse/companies/{{ company.id }}/departments/${departmentId}/toggle-active/`;

            $.ajax({
                url: toggleUrl,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: {
                    'department_id': departmentId
                },
                success: function(response) {
                    // بروزرسانی وضعیت در UI
                    const statusBadge = $('#status-' + departmentId);
                    const button = $(`.toggle-department-status[data-department-id="${departmentId}"]`);

                    if (newStatus) {
                        statusBadge.removeClass('bg-secondary').addClass('bg-success');
                        statusBadge.html('<i class="fas fa-check-circle me-1"></i>فعال');
                        button.removeClass('btn-outline-danger').addClass('btn-outline-success');
                    } else {
                        statusBadge.removeClass('bg-success').addClass('bg-secondary');
                        statusBadge.html('<i class="fas fa-times-circle me-1"></i>غیرفعال');
                        button.removeClass('btn-outline-success').addClass('btn-outline-danger');
                    }

                    showToast('success', `وضعیت بخش "${departmentName}" تغییر کرد`);
                },
                error: function(xhr) {
                    showToast('error', 'خطا در تغییر وضعیت بخش');
                }
            });
        }
    });

    // Modal حذف بخش
    $(document).on('click', '.delete-department', function() {
        const departmentId = $(this).data('department-id');
        const departmentName = $(this).data('department-name');

        $('#deleteDepartmentName').text(departmentName);
        $('#deleteDepartmentModal').data('department-id', departmentId);
        $('#deleteDepartmentModal').modal('show');
    });

    // فعال کردن دکمه حذف با تیک
    $('#confirmDepartmentDelete').change(function() {
        $('#confirmDepartmentDeleteBtn').prop('disabled', !$(this).is(':checked'));
    });

    // حذف بخش
    $('#confirmDepartmentDeleteBtn').click(function() {
        if (!$(this).prop('disabled')) {
            const departmentId = $('#deleteDepartmentModal').data('department-id');

            $.ajax({
                url: `/hse/companies/{{ company.id }}/departments/${departmentId}/delete/`,
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    $('#deleteDepartmentModal').modal('hide');
                    $(`tr[data-department-id="${departmentId}"]`).remove();
                    showToast('success', 'بخش با موفقیت حذف شد');
                },
                error: function(xhr) {
                    showToast('error', 'خطا در حذف بخش');
                }
            });
        }
    });

    // توابع کمکی
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(type, message) {
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        if (!$('.toast-container').length) {
            $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
        }

        $('.toast-container').append(toastHtml);

        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();

        setTimeout(() => {
            $(`#${toastId}`).remove();
        }, 5000);
    }
});
</script>

<style>
.card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-header {
    background-color: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}