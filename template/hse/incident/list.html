<!-- templates/hse/incident/list.html -->
{% extends 'base.html' %}

{% block title %}حوادث - {{ company.name }}{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'hse:incident_create' company.id %}" class="btn btn-danger">
        <i class="fas fa-plus me-2"></i>گزارش حادثه
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3 col-6">
        <div class="stat-card bg-primary">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="number">{{ stats.total }}</span>
            <small>کل حوادث</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card bg-success">
            <i class="fas fa-check-circle"></i>
            <span class="number">{{ stats.resolved }}</span>
            <small>حل شده</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card bg-danger">
            <i class="fas fa-radiation"></i>
            <span class="number">{{ stats.severe }}</span>
            <small>حادثه شدید</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card bg-warning">
            <i class="fas fa-calendar"></i>
            <span class="number">{{ stats.this_month }}</span>
            <small>این ماه</small>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-exclamation-triangle text-danger me-2"></i>لیست حوادث</h5>

        <div class="btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-filter me-2"></i>فیلتر
            </button>
            <div class="dropdown-menu p-3" style="width: 300px;">
                <form method="get">
                    <div class="mb-3">
                        <label class="form-label">وضعیت:</label>
                        <select name="status" class="form-select">
                            <option value="">همه</option>
                            {% for value, label in incident_status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">شدت:</label>
                        <select name="severity" class="form-select">
                            <option value="">همه</option>
                            {% for value, label in severity_choices %}
                            <option value="{{ value }}" {% if severity_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">نوع:</label>
                        <select name="type" class="form-select">
                            <option value="">همه</option>
                            {% for value, label in incident_type_choices %}
                            <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                        <a href="{% url 'hse:incident_list' company.id %}" class="btn btn-outline-secondary">حذف فیلتر</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card-body">
        {% if incidents %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>عنوان</th>
                        <th>نوع</th>
                        <th>شدت</th>
                        <th>وضعیت</th>
                        <th>تاریخ وقوع</th>
                        <th>گزارش دهنده</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in incidents %}
                    <tr>
                        <td>
                            <a href="{% url 'hse:incident_detail' company.id incident.id %}">
                                {{ incident.title }}
                            </a>
                            {% if incident.description %}
                            <small class="text-muted d-block">{{ incident.description|truncatechars:50 }}</small>
                            {% endif %}
                        </td>

                        <td>
                            <span class="badge bg-info">{{ incident.get_incident_type_display }}</span>
                        </td>

                        <td>
                            {% if incident.severity_level == 'SEVERE' %}
                            <span class="badge bg-danger">شدید</span>
                            {% elif incident.severity_level == 'HIGH' %}
                            <span class="badge bg-warning">بالا</span>
                            {% elif incident.severity_level == 'MEDIUM' %}
                            <span class="badge bg-info">متوسط</span>
                            {% else %}
                            <span class="badge bg-success">پایین</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if incident.status == 'RESOLVED' %}
                            <span class="badge bg-success">حل شده</span>
                            {% elif incident.status == 'CLOSED' %}
                            <span class="badge bg-secondary">بسته شده</span>
                            {% else %}
                            <span class="badge bg-warning">{{ incident.get_status_display }}</span>
                            {% endif %}
                        </td>

                        <td>{{ incident.incident_date|date:"Y/m/d H:i" }}</td>

                        <td>
                            {% if incident.reporter %}
                            {{ incident.reporter.user.get_full_name|default:incident.reporter.user.name}}
                            {% else %}
                            <span class="text-muted">نامشخص</span>
                            {% endif %}
                        </td>

                        <td>
                            <a href="{% url 'hse:incident_detail' company.id incident.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">هیچ حادثه‌ای گزارش نشده است</h5>
            <p class="text-muted mb-4">برای گزارش اولین حادثه، روی دکمه "گزارش حادثه" کلیک کنید.</p>
            <a href="{% url 'hse:incident_create' company.id %}" class="btn btn-danger">
                <i class="fas fa-plus me-2"></i>گزارش حادثه جدید
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}